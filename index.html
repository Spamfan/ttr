<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TTR v4</title>
    <style>
        /* CORE STYLES */
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
            font-family: 'Courier New', Courier, monospace;
            color: white;
            user-select: none;
            -webkit-user-select: none;
        }

        canvas {
            display: block;
        }

        /* UI OVERLAY */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .hud-text {
            position: absolute;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            pointer-events: auto;
        }

        #version-display { /* New */
            top: 10px;
            left: 10px;
        }
        
        #fps-counter { /* Relocated */
            top: 40px;
            right: 10px;
        }

        #pause-btn {
            top: 10px;
            right: 10px;
            cursor: pointer;
            border: 1px solid #fff;
        }

        /* PAUSE MODAL */
        #pause-modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #333;
            border: 2px solid #fff;
            padding: 20px;
            pointer-events: auto;
            text-align: center;
            min-width: 250px;
            box-shadow: 0 0 10px #000;
        }

        .modal-btn {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            background: #555;
            color: #fff;
            border: 1px solid #aaa;
            cursor: pointer;
        }

        .modal-btn.active {
            background: #00dd00;
            color: #000;
        }
        
        /* DEBUG OVERLAY */
        #debug-overlay {
            display: none;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30%;
            background: rgba(0,0,0,0.7);
            pointer-events: auto;
            overflow-y: scroll;
            font-size: 12px;
            box-sizing: border-box;
            padding: 5px;
            /* Usability Upgrade */
            user-select: text;
            -webkit-user-select: text;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="version-display" class="hud-text">v4</div>
        <div id="fps-counter" class="hud-text">FPS: 60</div>
        <div id="pause-btn" class="hud-text">PAUSE</div>

        <div id="pause-modal">
            <h3>PAUSED</h3>
            <button id="btn-toggle-fps" class="modal-btn active">Show FPS: ON</button>
            <button id="btn-auto-fire" class="modal-btn active">Mobile Auto-Fire: ON</button>
            <button id="btn-copy-log" class="modal-btn">Copy Log</button>
            <button id="btn-show-debug" class="modal-btn">Show Debug Log</button>
            <button id="btn-close-pause" class="modal-btn" style="background: #800;">CLOSE</button>
        </div>
        
        <div id="debug-overlay"></div>
    </div>

    <script>
        /** 
         * TTR ENGINE v4
         * Changes: Guaranteed Audio Fix, UI Layout, Debug Usability
         */

        const VERSION = "v4";

        // --- CONSTANTS & CONFIG ---
        const CONFIG = {
            playerSpeed: 250, fireRate: 1.0, bulletSpeed: 600, bulletLife: 1.0,
            bgColor: '#333333', gridColor: '#444444', gridSize: 50
        };

        // --- STATE MANAGEMENT ---
        const STATE = {
            lastTime: 0, showFPS: true, mobileAutoFire: true,
            isMobile: false, isPaused: false, audioInitialized: false
        };

        // --- DEBUG SYSTEM ---
        const DEBUG_LOG = [];
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            DEBUG_LOG.push(`[${timestamp}] ${message}`);
            console.log(message);
        }
        
        // --- AUDIO ENGINE ---
        let audioCtx = null;

        function initAudio() {
            if (STATE.audioInitialized) return;
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                STATE.audioInitialized = true;
                log("Audio Context Initialized Successfully.");
            } catch (e) {
                log("Error: Web Audio API not supported.");
            }
        }

        function playShootSound() {
            if (!audioCtx) return;
            // THE AUDIO FIX: Force resume on every shot if needed.
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        // --- INPUT STATE ---
        const INPUT = {
            keys: {}, mouse: { x: 0, y: 0, down: false }, moveVector: { x: 0, y: 0 },
            aimAngle: 0, isFiring: false,
            touches: {
                leftId: null, leftStart: { x: 0, y: 0 }, leftCurr: { x: 0, y: 0 },
                rightId: null, rightStart: { x: 0, y: 0 }, rightCurr: { x: 0, y: 0 }
            }
        };

        // --- GAME OBJECTS ---
        const PLAYER = { x: 0, y: 0, radius: 20, color: '#00ff00', barrelColor: '#000000', cooldown: 0, flash: 0 };
        let BULLETS = [];

        // --- DOM & CANVAS ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        let gridCanvas = null;

        const versionDiv = document.getElementById('version-display');
        const fpsDiv = document.getElementById('fps-counter');
        const pauseModal = document.getElementById('pause-modal');
        const debugOverlay = document.getElementById('debug-overlay');
        
        // --- INITIALIZATION ---
        function init() {
            log(`Initializing TTR ${VERSION}`);
            versionDiv.innerText = VERSION;
            resize();
            window.addEventListener('resize', resize);
            
            PLAYER.x = canvas.width / 2;
            PLAYER.y = canvas.height / 2;

            setupInputs();
            setupUI();
            
            const unlockAudio = () => {
                initAudio();
                window.removeEventListener('touchstart', unlockAudio);
                window.removeEventListener('mousedown', unlockAudio);
            };
            window.addEventListener('touchstart', unlockAudio);
            window.addEventListener('mousedown', unlockAudio);

            requestAnimationFrame(gameLoop);
            log("Initialization Complete. Game loop started.");
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            createGridBackground();
            log(`Canvas resized to ${canvas.width}x${canvas.height}. Grid re-rendered.`);
        }

        // --- PERFORMANCE OPTIMIZATION ---
        function createGridBackground() {
            gridCanvas = document.createElement('canvas');
            gridCanvas.width = canvas.width;
            gridCanvas.height = canvas.height;
            const gridCtx = gridCanvas.getContext('2d');
            gridCtx.fillStyle = CONFIG.bgColor;
            gridCtx.fillRect(0, 0, gridCanvas.width, gridCanvas.height);
            gridCtx.strokeStyle = CONFIG.gridColor;
            gridCtx.lineWidth = 1;
            gridCtx.beginPath();
            for (let x = 0; x < gridCanvas.width; x += CONFIG.gridSize) {
                gridCtx.moveTo(x, 0); gridCtx.lineTo(x, gridCanvas.height);
            }
            for (let y = 0; y < gridCanvas.height; y += CONFIG.gridSize) {
                gridCtx.moveTo(0, y); gridCtx.lineTo(canvas.width, y);
            }
            gridCtx.stroke();
        }

        // --- INPUT HANDLING ---
        function setupInputs() {
            window.addEventListener('keydown', e => { INPUT.keys[e.key.toLowerCase()] = true; STATE.isMobile = false; });
            window.addEventListener('keyup', e => { INPUT.keys[e.key.toLowerCase()] = false; });
            window.addEventListener('mousemove', e => { INPUT.mouse.x = e.clientX; INPUT.mouse.y = e.clientY; STATE.isMobile = false; });
            window.addEventListener('mousedown', () => { INPUT.mouse.down = true; STATE.isMobile = false; });
            window.addEventListener('mouseup', () => { INPUT.mouse.down = false; });
            canvas.addEventListener('touchstart', handleTouch, { passive: false });
            canvas.addEventListener('touchmove', handleTouch, { passive: false });
            canvas.addEventListener('touchend', handleTouch, { passive: false });
        }

        function handleTouch(e) {
            e.preventDefault();
            STATE.isMobile = true;
            INPUT.touches.leftId = null;
            INPUT.touches.rightId = null;
            for (let touch of e.touches) {
                if (touch.clientX < canvas.width / 2 && INPUT.touches.leftId === null) {
                    INPUT.touches.leftId = touch.identifier;
                    INPUT.touches.leftCurr = { x: touch.clientX, y: touch.clientY };
                    if (e.type === 'touchstart') INPUT.touches.leftStart = { x: touch.clientX, y: touch.clientY };
                } else if (INPUT.touches.rightId === null) {
                    INPUT.touches.rightId = touch.identifier;
                    INPUT.touches.rightCurr = { x: touch.clientX, y: touch.clientY };
                    if (e.type === 'touchstart') INPUT.touches.rightStart = { x: touch.clientX, y: touch.clientY };
                }
            }
            if (INPUT.touches.leftId === null) { INPUT.moveVector.x = 0; INPUT.moveVector.y = 0; }
        }

        // --- LOGIC UPDATE ---
        function update(dt) {
            if (STATE.isPaused) return;
            if (STATE.isMobile) {
                if (INPUT.touches.leftId !== null) {
                    let dx = INPUT.touches.leftCurr.x - INPUT.touches.leftStart.x;
                    let dy = INPUT.touches.leftCurr.y - INPUT.touches.leftStart.y;
                    let dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 0) {
                        let power = Math.min(dist, 50) / 50;
                        INPUT.moveVector = { x: (dx / dist) * power, y: (dy / dist) * power };
                    }
                }
                if (INPUT.touches.rightId !== null) {
                    let dx = INPUT.touches.rightCurr.x - INPUT.touches.rightStart.x;
                    let dy = INPUT.touches.rightCurr.y - INPUT.touches.rightStart.y;
                    if (dx !== 0 || dy !== 0) INPUT.aimAngle = Math.atan2(dy, dx);
                }
                INPUT.isFiring = STATE.mobileAutoFire && INPUT.touches.rightId !== null;
            } else {
                INPUT.moveVector = { x: 0, y: 0 };
                if (INPUT.keys['w'] || INPUT.keys['arrowup']) INPUT.moveVector.y = -1;
                if (INPUT.keys['s'] || INPUT.keys['arrowdown']) INPUT.moveVector.y = 1;
                if (INPUT.keys['a'] || INPUT.keys['arrowleft']) INPUT.moveVector.x = -1;
                if (INPUT.keys['d'] || INPUT.keys['arrowright']) INPUT.moveVector.x = 1;
                if (INPUT.moveVector.x !== 0 || INPUT.moveVector.y !== 0) {
                    let len = Math.sqrt(INPUT.moveVector.x ** 2 + INPUT.moveVector.y ** 2);
                    INPUT.moveVector.x /= len;
                    INPUT.moveVector.y /= len;
                }
                INPUT.aimAngle = Math.atan2(INPUT.mouse.y - PLAYER.y, INPUT.mouse.x - PLAYER.x);
                INPUT.isFiring = INPUT.mouse.down;
            }

            PLAYER.x += INPUT.moveVector.x * CONFIG.playerSpeed * dt;
            PLAYER.y += INPUT.moveVector.y * CONFIG.playerSpeed * dt;
            PLAYER.x = Math.max(PLAYER.radius, Math.min(canvas.width - PLAYER.radius, PLAYER.x));
            PLAYER.y = Math.max(PLAYER.radius, Math.min(canvas.height - PLAYER.radius, PLAYER.y));
            if (PLAYER.cooldown > 0) PLAYER.cooldown -= dt;
            if (INPUT.isFiring && PLAYER.cooldown <= 0) {
                fireWeapon();
                PLAYER.cooldown = CONFIG.fireRate;
            }
            for (let i = BULLETS.length - 1; i >= 0; i--) {
                let b = BULLETS[i];
                b.x += b.vx * dt;
                b.y += b.vy * dt;
                b.life -= dt;
                if (b.life <= 0) BULLETS.splice(i, 1);
            }
        }

        function fireWeapon() {
            playShootSound();
            PLAYER.flash = 0.1;
            let barrelLen = PLAYER.radius + 10;
            let mx = PLAYER.x + Math.cos(INPUT.aimAngle) * barrelLen;
            let my = PLAYER.y + Math.sin(INPUT.aimAngle) * barrelLen;
            BULLETS.push({
                x: mx, y: my,
                vx: Math.cos(INPUT.aimAngle) * CONFIG.bulletSpeed,
                vy: Math.sin(INPUT.aimAngle) * CONFIG.bulletSpeed,
                life: CONFIG.bulletLife
            });
        }

        // --- RENDER ---
        function draw() {
            ctx.drawImage(gridCanvas, 0, 0);
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let b of BULLETS) {
                let tailX = b.x - (b.vx / CONFIG.bulletSpeed) * 15;
                let tailY = b.y - (b.vy / CONFIG.bulletSpeed) * 15;
                ctx.moveTo(tailX, tailY);
                ctx.lineTo(b.x, b.y);
            }
            ctx.stroke();
            ctx.save();
            ctx.translate(PLAYER.x, PLAYER.y);
            ctx.rotate(INPUT.aimAngle);
            ctx.fillStyle = PLAYER.flash > 0 ? '#ffff00' : PLAYER.color;
            if (PLAYER.flash > 0) PLAYER.flash -= 0.016;
            ctx.fillRect(-PLAYER.radius, -PLAYER.radius, PLAYER.radius * 2, PLAYER.radius * 2);
            ctx.fillStyle = PLAYER.barrelColor;
            ctx.fillRect(0, -5, PLAYER.radius * 2, 10);
            ctx.restore();
            if (INPUT.touches.leftId !== null) drawJoystick(INPUT.touches.leftStart, INPUT.touches.leftCurr);
            if (INPUT.touches.rightId !== null) drawJoystick(INPUT.touches.rightStart, INPUT.touches.rightCurr);
        }

        function drawJoystick(start, curr) {
            ctx.beginPath();
            ctx.arc(start.x, start.y, 50, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(curr.x, curr.y, 20, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.fill();
        }

        // --- UI & SETTINGS ---
        function setupUI() {
            const btnPause = document.getElementById('pause-btn');
            const btnClose = document.getElementById('btn-close-pause');
            const btnToggleFPS = document.getElementById('btn-toggle-fps');
            const btnAutoFire = document.getElementById('btn-auto-fire');
            const btnShowDebug = document.getElementById('btn-show-debug');
            const btnCopyLog = document.getElementById('btn-copy-log');

            btnPause.onclick = () => {
                STATE.isPaused = true;
                pauseModal.style.display = 'block';
                debugOverlay.style.display = 'none';
            };
            btnClose.onclick = () => {
                STATE.isPaused = false;
                pauseModal.style.display = 'none';
                debugOverlay.style.display = 'none';
                STATE.lastTime = performance.now();
            };
            btnToggleFPS.onclick = () => {
                STATE.showFPS = !STATE.showFPS;
                fpsDiv.style.display = STATE.showFPS ? 'block' : 'none';
                btnToggleFPS.innerText = `Show FPS: ${STATE.showFPS ? 'ON' : 'OFF'}`;
                btnToggleFPS.classList.toggle('active', STATE.showFPS);
            };
            btnAutoFire.onclick = () => {
                STATE.mobileAutoFire = !STATE.mobileAutoFire;
                btnAutoFire.innerText = `Mobile Auto-Fire: ${STATE.mobileAutoFire ? 'ON' : 'OFF'}`;
                btnAutoFire.classList.toggle('active', STATE.mobileAutoFire);
            };
            btnShowDebug.onclick = () => {
                pauseModal.style.display = 'none';
                debugOverlay.style.display = 'block';
                debugOverlay.innerHTML = DEBUG_LOG.map(msg => `<div>${msg}</div>`).join('');
                debugOverlay.scrollTop = debugOverlay.scrollHeight;
            };
            btnCopyLog.onclick = () => {
                const logText = DEBUG_LOG.join('\n');
                navigator.clipboard.writeText(logText).then(() => {
                    log("Log copied to clipboard!");
                    alert("Debug log copied to clipboard!");
                }).catch(err => {
                    log("Error copying log to clipboard.");
                    alert("Could not copy log. See console for details.");
                });
            };
        }

        // --- GAME LOOP ---
        function gameLoop(timestamp) {
            if (!STATE.lastTime) STATE.lastTime = timestamp;
            const dt = (timestamp - STATE.lastTime) / 1000;
            STATE.lastTime = timestamp;

            update(dt);
            draw();

            if (STATE.showFPS) {
                fpsDiv.innerText = `FPS: ${Math.round(1 / dt)}`;
            }

            requestAnimationFrame(gameLoop);
        }

        // Launch
        init();

    </script>
</body>
</html>